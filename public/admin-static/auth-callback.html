<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>Authenticating...</title>
</head>
<body>
  <p id="status">Processing...</p>
  
  <script>
    (function() {
      const params = new URLSearchParams(window.location.search);
      const code = params.get('code');
      
      if (!code) {
        // NO CODE - redirect to GitHub immediately
        document.getElementById('status').textContent = 'Redirecting to GitHub...';
        const clientId = 'Ov23liafFGErfmejn48L';
        const redirectUri = encodeURIComponent('https://kwslinkhout.be/admin-static/auth-callback.html');
        window.location.replace('https://github.com/login/oauth/authorize?client_id=' + clientId + '&redirect_uri=' + redirectUri + '&scope=repo');
        return;
      }
      
      // We have a code - exchange it
      document.getElementById('status').textContent = 'Exchanging code...';
      
      fetch('/api/auth?code=' + encodeURIComponent(code))
        .then(r => r.json())
        .then(data => {
          if (data.token) {
            localStorage.setItem('decap-cms-user', JSON.stringify({
              backendName: 'github',
              token: data.token
            }));
            
            if (window.opener) {
              window.opener.postMessage('authorization:github:success:' + data.token, window.location.origin);
            }
            
            setTimeout(() => window.close(), 200);
          } else {
            document.getElementById('status').textContent = 'Error: ' + (data.error || 'No token');
          }
        })
        .catch(err => {
          document.getElementById('status').textContent = 'Error: ' + err.message;
        });
    })();
  </script>
</body>
</html>
