<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <meta http-equiv="Cache-Control" content="no-store, no-cache, must-revalidate, proxy-revalidate">
  <meta http-equiv="Pragma" content="no-cache">
  <meta http-equiv="Expires" content="0">
  <title>Authenticating...</title>
</head>
<body>
  <p>Loading...</p>
  <script>
    // IMMEDIATE check - before anything else
    const url = new URL(window.location.href);
    const code = url.searchParams.get('code');
    
    if (!code) {
      // CRITICAL: Don't show error, just redirect to GitHub
      window.location.replace('https://github.com/login/oauth/authorize?client_id=Ov23liafFGErfmejn48L&redirect_uri=https://kwslinkhout.be/admin-static/auth-callback.html&scope=repo&t=' + Date.now());
    } else {
      // Have code - process it
      document.body.innerHTML = '<p>Completing login...</p>';
      
      fetch('/api/auth?code=' + encodeURIComponent(code))
        .then(r => r.json())
        .then(data => {
          if (data.token) {
            localStorage.setItem('decap-cms-user', JSON.stringify({backendName: 'github', token: data.token}));
            if (window.opener) {
              window.opener.postMessage('authorization:github:success:' + data.token, '*');
            }
            document.body.innerHTML = '<p>Success! Closing...</p>';
            setTimeout(() => window.close(), 300);
          } else {
            // No token, try again
            window.location.reload();
          }
        })
        .catch(() => {
          // Error, try again
          setTimeout(() => window.location.reload(), 1000);
        });
    }
  </script>
</body>
</html>
