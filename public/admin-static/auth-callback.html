<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
  <title>Authenticating...</title>
  <style>
    body { font-family: sans-serif; display: flex; align-items: center; justify-content: center; min-height: 100vh; margin: 0; background: #f5f5f5; }
    .container { background: white; padding: 40px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); text-align: center; max-width: 500px; }
    .error { color: #d32f2f; }
    .success { color: #388e3c; }
    pre { background: #f5f5f5; padding: 10px; text-align: left; overflow-x: auto; font-size: 12px; }
  </style>
</head>
<body>
  <div class="container">
    <h1>Authenticating...</h1>
    <p id="status">Please wait...</p>
    <pre id="debug"></pre>
  </div>
  
  <script>
    function log(msg) {
      document.getElementById('debug').textContent += msg + '\n';
    }
    
    (function() {
      const statusEl = document.getElementById('status');
      
      log('URL: ' + window.location.href);
      
      const params = new URLSearchParams(window.location.search);
      const code = params.get('code');
      const error = params.get('error');
      
      log('Code: ' + (code ? 'present' : 'missing'));
      log('Error: ' + error);
      
      if (!code && !error) {
        statusEl.textContent = 'Redirecting to GitHub...';
        const clientId = 'Ov23liafFGErfmejn48L';
        const redirectUri = encodeURIComponent('https://kwslinkhout.be/admin-static/auth-callback.html');
        const url = `https://github.com/login/oauth/authorize?client_id=${clientId}&redirect_uri=${redirectUri}&scope=repo&_=${Date.now()}`;
        window.location.replace(url);
        return;
      }
      
      if (error) {
        statusEl.textContent = 'Error: ' + error;
        statusEl.className = 'error';
        return;
      }
      
      statusEl.textContent = 'Exchanging code for token...';
      
      fetch('/api/auth?code=' + encodeURIComponent(code))
        .then(async res => {
          log('Response status: ' + res.status);
          const text = await res.text();
          log('Response text: ' + text.substring(0, 200));
          
          // Try to parse as JSON
          try {
            return JSON.parse(text);
          } catch (e) {
            throw new Error('Invalid JSON response: ' + text.substring(0, 100));
          }
        })
        .then(data => {
          log('Parsed data: ' + JSON.stringify(data, null, 2).substring(0, 200));
          
          if (data.token) {
            statusEl.textContent = 'Success!';
            statusEl.className = 'success';
            
            localStorage.setItem('decap-cms-user', JSON.stringify({
              backendName: 'github',
              token: data.token
            }));
            
            if (window.opener) {
              window.opener.postMessage('authorization:github:success:' + data.token, window.location.origin);
            }
            
            setTimeout(() => window.close(), 500);
          } else {
            statusEl.textContent = 'Error: ' + (data.error || 'No token');
            statusEl.className = 'error';
          }
        })
        .catch(err => {
          log('Error: ' + err.message);
          statusEl.textContent = 'Error: ' + err.message;
          statusEl.className = 'error';
        });
    })();
  </script>
</body>
</html>
