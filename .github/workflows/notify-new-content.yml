name: Notify on New Content

on:
  push:
    branches: [main]

jobs:
  notify:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 2

      - name: Debug info
        run: |
          echo "=== DEBUG INFO ==="
          echo "Changed files:"
          git diff --name-only HEAD^ HEAD || echo "Could not get diff"
          echo ""
          echo "Full commit:"
          git log -1 --format=full
          echo ""
          echo "Has webhook secret: ${{ secrets.DISCORD_WEBHOOK_URL != '' }}"

      - name: Send Discord notification
        env:
          WEBHOOK: ${{ secrets.DISCORD_WEBHOOK_URL }}
        run: |
          if [ -z "$WEBHOOK" ]; then
            echo "ERROR: DISCORD_WEBHOOK_URL is not set!"
            exit 1
          fi
          
          echo "Sending Discord notification..."
          
          curl -X POST \
            -H "Content-Type: application/json" \
            -d '{
              "username": "KWS Linkhout CMS",
              "content": "üìù Nieuwe content toegevoegd! Ga naar https://kwslinkhout.be/admin om te reviewen."
            }' \
            "$WEBHOOK"
          
          echo "Done!"
        # Remove this 'if' to always send notifications (for testing)
        if: contains(github.event.head_commit.message, 'Create') || contains(github.event.head_commit.message, 'Update')
